name: Sync Upstream

on:
  schedule:
    - cron: "0 2 * * *"
  workflow_dispatch:

concurrency:
  group: sync-upstream
  cancel-in-progress: false

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    env:
      UPSTREAM_REPO: llamastack/llama-stack
      UPSTREAM_BRANCH: main
      DOWNSTREAM_BRANCH: sync-upstream-temp
      SYNC_BRANCH: automation/sync-upstream
    steps:
      - name: Check out downstream repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ env.DOWNSTREAM_BRANCH }}

      - name: Sync branch with upstream
        uses: repo-sync/github-sync@v2
        with:
          source_repo: ${{ env.UPSTREAM_REPO }}
          source_branch: ${{ env.UPSTREAM_BRANCH }}
          destination_repo: "VaishnaviHire/llama-stack"
          destination_branch: ${{ env.SYNC_BRANCH }}
          sync_tags: "true"
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check for differences
        id: diff
        run: |
          set -eo pipefail
          git fetch origin "${SYNC_BRANCH}" --prune
          git fetch origin "${DOWNSTREAM_BRANCH}" --prune
          if git show-ref --verify --quiet "refs/remotes/origin/${SYNC_BRANCH}"; then
            ahead=$(git rev-list --count "origin/${DOWNSTREAM_BRANCH}..origin/${SYNC_BRANCH}")
          else
            ahead=0
          fi
          if [ "${ahead}" -gt 0 ]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Create or update pull request
        if: steps.diff.outputs.changed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -eo pipefail
          pr_number=$(gh pr list --head "${SYNC_BRANCH}" --state open --json number --jq '.[0].number' || true)
          if [ -z "${pr_number}" ]; then
            gh pr create \
              --title "Sync upstream ${UPSTREAM_BRANCH} into ${DOWNSTREAM_BRANCH}" \
              --body "Automated upstream sync triggered by workflow run [${GITHUB_RUN_ID}](${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID})." \
              --head "${SYNC_BRANCH}" \
              --base "${DOWNSTREAM_BRANCH}"
          else
            echo "Pull request #${pr_number} already open for ${SYNC_BRANCH}; updated branch pushed."
          fi

      - name: Cleanup sync branch when up to date
        if: steps.diff.outputs.changed == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -eo pipefail
          git fetch origin --prune
          if git show-ref --verify --quiet "refs/remotes/origin/${SYNC_BRANCH}"; then
            pr_number=$(gh pr list --head "${SYNC_BRANCH}" --json number --jq '.[0].number' || true)
            if [ -z "${pr_number}" ]; then
              git push origin ":${SYNC_BRANCH}"
              echo "Deleted remote branch ${SYNC_BRANCH}."
            else
              echo "Skipping deletion; pull request #${pr_number} still exists."
            fi
          else
            echo "Sync branch ${SYNC_BRANCH} not found on origin."
          fi

name: Sync Upstream

run-name: Sync main with llamastack/llama-stack

on:
  schedule:
    - cron: "0 2 * * *"
  workflow_dispatch:

concurrency:
  group: sync-upstream
  cancel-in-progress: false

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    env:
      UPSTREAM_REPO: llamastack/llama-stack
      UPSTREAM_BRANCH: main
      DOWNSTREAM_BRANCH: main
      SYNC_BRANCH: automation/sync-upstream
    steps:
      - name: Check out downstream repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
        with:
          fetch-depth: 0
          ref: ${{ env.DOWNSTREAM_BRANCH }}

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Fetch upstream
        env:
          UPSTREAM_URL: https://github.com/${{ env.UPSTREAM_REPO }}.git
        shell: bash
        run: |
          if git remote get-url upstream >/dev/null 2>&1; then
            git remote set-url upstream "${UPSTREAM_URL}"
          else
            git remote add upstream "${UPSTREAM_URL}"
          fi
          git fetch origin "${DOWNSTREAM_BRANCH}" --prune
          git fetch upstream "${UPSTREAM_BRANCH}" --prune
          git fetch upstream --tags --prune

      - name: Prepare sync branch
        shell: bash
        run: |
          git reset --hard "origin/${DOWNSTREAM_BRANCH}"
          git checkout -B "${SYNC_BRANCH}" "origin/${DOWNSTREAM_BRANCH}"

      - name: Merge upstream changes
        id: merge_upstream
        shell: bash
        run: |
          # Merge upstream/main into sync branch
          if git merge --no-edit "upstream/${UPSTREAM_BRANCH}"; then
            # Merge successful - check if there are changes
            ahead=$(git rev-list --count "origin/${DOWNSTREAM_BRANCH}..HEAD")
            if [ "${ahead}" -gt 0 ]; then
              echo "changed=true" >> "$GITHUB_OUTPUT"
            else
              echo "changed=false" >> "$GITHUB_OUTPUT"
            fi
            echo "conflicts=false" >> "$GITHUB_OUTPUT"
          else
            # Merge conflicts detected - abort and create branch from upstream
            echo " Merge conflicts detected"
            git merge --abort || true
            
            # Create branch from upstream/main - conflicts will be visible when merging this PR
            git checkout -B "${SYNC_BRANCH}" "upstream/${UPSTREAM_BRANCH}"
            echo "changed=true" >> "$GITHUB_OUTPUT"
            echo "conflicts=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Push sync branch
        if: steps.merge_upstream.outputs.changed == 'true'
        shell: bash
        run: |
          git push --force --set-upstream origin "${SYNC_BRANCH}"

      - name: Create or update pull request
        if: steps.merge_upstream.outputs.changed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          owner="${GITHUB_REPOSITORY%%/*}"
          pr_number=$(gh api "repos/${GITHUB_REPOSITORY}/pulls" -X GET -f state=open -f head="${owner}:${SYNC_BRANCH}" --jq '.[0].number' || true)

          # Build PR body
          pr_body="Automated upstream sync triggered by workflow run [${GITHUB_RUN_ID}](${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID})."

          # Make conflicts message prominent - check first
          if [ "${steps.merge_upstream.outputs.conflicts}" == "true" ]; then
            pr_body=" **MERGE CONFLICTS DETECTED** "$'\n\n'"${pr_body}"
          fi

          # Set PR title - include conflict warning if applicable
          if [ "${steps.merge_upstream.outputs.conflicts}" == "true" ]; then
            pr_title=" [CONFLICTS] Sync upstream ${UPSTREAM_BRANCH} into ${DOWNSTREAM_BRANCH}"
          else
            pr_title="Sync upstream ${UPSTREAM_BRANCH} into ${DOWNSTREAM_BRANCH}"
          fi

          if [ -z "${pr_number}" ]; then
            pr_number=$(gh api "repos/${GITHUB_REPOSITORY}/pulls" -X POST \
              -f title="${pr_title}" \
              -f body="${pr_body}" \
              -f head="${owner}:${SYNC_BRANCH}" \
              -f base="${DOWNSTREAM_BRANCH}" \
              --jq '.number')
            echo "Created pull request #${pr_number}."
          else
            # Update existing PR title if conflicts are detected
            if [ "${steps.merge_upstream.outputs.conflicts}" == "true" ]; then
              gh pr edit "${pr_number}" --title "${pr_title}" || true
            fi
            echo "Pull request #${pr_number} already open for ${SYNC_BRANCH}; updated branch pushed."
          fi

      - name: Cleanup sync branch when up to date
        if: steps.merge_upstream.outputs.changed == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          git fetch origin --prune
          owner="${GITHUB_REPOSITORY%%/*}"
          pr_number=$(gh api "repos/${GITHUB_REPOSITORY}/pulls" -X GET -f state=open -f head="${owner}:${SYNC_BRANCH}" --jq '.[0].number' || true)
          if [ -z "${pr_number}" ]; then
            if git show-ref --verify --quiet "refs/remotes/origin/${SYNC_BRANCH}"; then
              git push origin ":${SYNC_BRANCH}"
              echo "Deleted remote branch ${SYNC_BRANCH}."
            else
              echo "Sync branch ${SYNC_BRANCH} not found on origin."
            fi
          else
            echo "Skipping deletion; pull request #${pr_number} still exists."
          fi
